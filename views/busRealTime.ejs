<!DOCTYPE html>
<html>
<head>
	<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
	<title>RTBTS</title>
	<meta content='width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0, shrink-to-fit=no' name='viewport' />
	<link rel="stylesheet" href="/stylesheets/bootstrap.min.css">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Nunito:200,200i,300,300i,400,400i,600,600i,700,700i,800,800i,900,900i">
	<link rel="stylesheet" href="/stylesheets/ready.css">
	<link rel="stylesheet" href="/stylesheets/demo.css">
</head>
<body>
	<div class="wrapper">
		<div class="main-header">
			<div class="logo-header">
				<a href="/rtbts/bus/dashboard" class="logo">
					RTBTS
				</a>
				<button class="navbar-toggler sidenav-toggler ml-auto" type="button" data-toggle="collapse" data-target="collapse" aria-controls="sidebar" aria-expanded="false" aria-label="Toggle navigation">
					<span class="navbar-toggler-icon"></span>
				</button>
			</div>
		</div>
		<div class="sidebar">
			<div class="scrollbar-inner sidebar-wrapper">
				<div class="user">
					<div class="photo">
						<img src="/images/account_img.png" alt="user-img" width="36" class="img-circle">
					</div>
					<div class="info">
						<a class="" data-toggle="collapse" href="#collapseExample" aria-expanded="true">
							<span>
								User
								<span class="user-level"><%= userEmail %></span>
								<span class="caret"></span>
							</span>
						</a>
						<div class="clearfix"></div>
						<div class="collapse in" id="collapseExample" aria-expanded="true" style="">
							<ul class="nav">
								<li>
									<a class="dropdown-item" href="/rtbts/user/logout">
										<span class="link-collapse"> Logout</span>
									</a>
								</li>
							</ul>
						</div>
					</div>
				</div>
				<ul class="nav">
					<li class="nav-item">
						<a href="/rtbts/bus/dashboard">
							<i class="la la-dashboard"></i>
							<p>Dashboard</p>
						</a>
					</li>
					<li class="nav-item active">
						<a href="/rtbts/buses">
							<i class="la la-bus"></i>
							<p>Buses</p>
						</a>
					</li>
					<li class="nav-item">
						<a href="/rtbts/routes">
							<i class="la la-location-arrow"></i>
							<p>Routes</p>
						</a>
					</li>
					<li class="nav-item">
						<a href="/rtbts/route/create">
							<i class="la la-plus-square-o"></i>
							<p>Add Route</p>
						</a>
					</li>
					<li class="nav-item">
						<a href="/rtbts/bus/create">
							<i class="la la-plus-square-o"></i>
							<p>Add Bus</p>
						</a>
					</li>
				</ul>
			</div>
		</div>
		<div class="main-panel">
			<div class="content">
				<div class="container-fluid">
					<h4 class="page-title">Bus <%= theBus.busNum %></h4>
					<div class="row d-flex justify-content-center align-content-center">
						<div class="col-md-11">
							<div class="card">
								<div class="card-header">
									<nav class="navbar navbar-expand-sm bg-light navbar-light subnav">
										<ul class="navbar-nav">
                                            <li class="nav-item active">
												<a class="nav-link" href='<%= "/rtbts/bus/" + theBus._id + "/realTime" %>'>Real Time</a>
											</li>
											<li class="nav-item">
												<a class="nav-link" href='<%= "/rtbts/bus/" + theBus._id + "/travelHistory" %>'>Travel History</a>
											</li>
											<li class="nav-item">
												<a class="nav-link" href='<%= "/rtbts/bus/" + theBus._id %>'>Information</a>
											</li>
											<li class="nav-item mt-2">
												<a href='<%= "/rtbts/bus/" + theBus._id + "/edit" %>' role="button" aria-expanded="false"> 
													<span class="btn btn-primary pl-5 pr-5"><i class="la la-edit mb-1"></i>&nbsp;EDIT</span>
												</a>
											</li>
										</ul>
									</nav>
								</div>
								<div class="card-body pb-5">
									<div class="row mt-4">
										<div class="col-md-8">
											<div class="card-body">
												<div class="row justify-content-center">
													<div class="col-md-12" id="map" style="height:500px;">
													</div>
												</div>
											</div>
										</div>
										<div class="col-md-4">
											<div class="mt-4">
												<h6 class="h6">Route</h6>
												<p><%- theRoute.routeNum + " (" + theRoute.departure + " -> " + theRoute.arrival + ")" %></p>
											</div>
											<div class="mt-4">
												<h6 class="h6">Latitude</h6>
												<p id="latView">Not Available</p>
											</div>
											<div class="mt-4">
												<h6 class="h6">Longitude</h6>
												<p id="lngView">Not Available</p>
											</div>
											<div class="mt-4">
												<h6 class="h6">Speeds</h6>
												<p id="spdView">Not Available</p>
											</div>
										</div>
									</div>
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>
			<footer class="footer mt-5">
				<div class="container-fluid">
					<nav class="pull-left">
						<ul class="nav">
							<li class="nav-item">
								<a class="nav-link" href="http://www.themekita.com">
									ThemeKita
								</a>
							</li>
							<li class="nav-item">
								<a class="nav-link" href="#">
									Help
								</a>
							</li>
							<li class="nav-item">
								<a class="nav-link" href="https://themewagon.com/license/#free-item">
									Licenses
								</a>
							</li>
						</ul>
					</nav>
					<div class="copyright ml-auto">
						2018, made with <i class="la la-heart heart text-danger"></i> by <a href="http://www.themekita.com">ThemeKita</a>
					</div>				
				</div>
			</footer>
		</div>
	</div>
	<!-- Modal -->
	<div class="modal fade" id="modalUpdate" tabindex="-1" role="dialog" aria-labelledby="modalUpdatePro" aria-hidden="true">
		<div class="modal-dialog modal-dialog-centered" role="document">
			<div class="modal-content">
				<div class="modal-header bg-primary">
					<h6 class="modal-title"><i class="la la-frown-o"></i> Under Development</h6>
					<button type="button" class="close" data-dismiss="modal" aria-label="Close">
						<span aria-hidden="true">&times;</span>
					</button>
				</div>
				<div class="modal-body text-center">									
					<p>Currently the pro version of the <b>Ready Dashboard</b> Bootstrap is in progress development</p>
					<p>
						<b>We'll let you know when it's done</b></p>
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
				</div>
			</div>
		</div>
	</div>
</body>
<script src="/javascripts/core/jquery.3.2.1.min.js"></script>
<script src="/javascripts/plugin/jquery-ui-1.12.1.custom/jquery-ui.min.js"></script>
<script src="/javascripts/core/popper.min.js"></script>
<script src="/javascripts/core/bootstrap.min.js"></script>
<script src="/javascripts/plugin/chartist/chartist.min.js"></script>
<script src="/javascripts/plugin/chartist/plugin/chartist-plugin-tooltip.min.js"></script>
<script src="/javascripts/plugin/bootstrap-notify/bootstrap-notify.min.js"></script>
<script src="/javascripts/plugin/bootstrap-toggle/bootstrap-toggle.min.js"></script>
<script src="/javascripts/plugin/jquery-mapael/jquery.mapael.min.js"></script>
<script src="/javascripts/plugin/jquery-mapael/maps/world_countries.min.js"></script>
<script src="/javascripts/plugin/chart-circle/circles.min.js"></script>
<script src="/javascripts/plugin/jquery-scrollbar/jquery.scrollbar.min.js"></script>
<script src="/javascripts/ready.min.js"></script>
<script src="/javascripts/demo.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.3.0/socket.io.js"></script>
<script>
      var map;
      function initMap() {
        map = new google.maps.Map(document.getElementById('map'), {
          center: {lat: 3.110050, lng: 101.583},
          zoom: 17
  });

  marker = new google.maps.Marker({
							position: {lat:3.110050, lng: 101.583},
							map: map,
						});
	  }
	  function updateLocation(latitude, longitude){
	map.setCenter({lat:latitude, lng:longitude, alt:0});
	 marker.setPosition({lat:latitude, lng:longitude, alt:0});
}
  var socket = io.connect('http://ec2-34-203-205-172.compute-1.amazonaws.com:8080');
  socket.on('iot_data', function(msg){
  	console.log(msg);
	  //updateLocation(parseFloat(msg.state.reported.latitude), parseFloat(msg.state.reported.longitude));
	  document.getElementById('latView').innerHTML = msg.state.reported.latitude;
	  document.getElementById('lngView').innerHTML = msg.state.reported.longitude;
	  document.getElementById('spdView').innerHTML = msg.state.reported.speed;
  });
	</script>

<% var thingShadow = awsIot.thingShadow({ 
	keyPath: '/home/ec2-user/rtbts-demo/rtbts/public/certs/5a553074b9-private.pem.key', 
	certPath: '/home/ec2-user/rtbts-demo/rtbts/public/certs/5a553074b9-certificate.pem.crt', 
	caPath: '/home/ec2-user/rtbts-demo/rtbts/public/certs/rootCA.pem', 
	clientId: Math.random().toString(36).substr(2, 8), 
	host: 'a2pg831a2zywmf-ats.iot.us-east-1.amazonaws.com', 
	port: 8883, 
	region: 'us-east-1', 
	debug: true, // optional to see logs on console 
  });
  console.log(TAG, 'ok');

thingShadow.on('connect', function() { 
	console.log(TAG, 'Connected.'); 
	thingShadow.register("bus", {}, function() { 
		console.log(TAG, 'Registered.'); 
		console.log(TAG, 'Reading data in ' + INIT_DELAY + ' seconds.');

		setTimeout(sendData, INIT_DELAY * 1000); // wait for `INIT_DELAY` seconds before reading the first record 
	}); 
});

thingShadow.on('status', function(thingName, stat, clientToken, stateObject) { 
	//console.log(TAG, 'received ' + stat + ' on ' + thingName + ':', stateObject);
	io.emit('iot_data', stateObject);
});

function sendData() { 
	var clientTokenUpdate = thingShadow.get("bus"); 
	if (clientTokenUpdate === null) { 
		console.log(TAG, 'Shadow get failed, operation still in progress'); 
	} else { 
		console.log(TAG, 'Shadow get success.'); 
	} 
	
	// keep sending the data every 30 seconds 
	console.log(TAG, 'Reading data again in 30 seconds.'); 
	setTimeout(sendData, 10000); // 30,000 ms => 30 seconds 
}%>
<<<<<<< HEAD
<<<<<<< HEAD
    <script src="https://maps.googleapis.com/maps/api/js?key=<API_KEY>
&callback=initMap"
=======
    <script src="https://maps.googleapis.com/maps/api/js?key=&callback=initMap"
>>>>>>> 70b0d87b36d13f43462b37819ca9c4e739ad8db8
	async defer></script>
</html>